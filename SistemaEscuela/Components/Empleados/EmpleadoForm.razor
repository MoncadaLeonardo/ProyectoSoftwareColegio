@page "/empleados/nuevo"
@page "/empleados/editar/{Id:int}"
@using EL
@using BL
@using DAL



@inject EmpleadoService EmpleadoService
@inject DepartamentoService DepartamentoService
@inject HorarioService HorarioService
@inject RolService RolService
@inject IUnitOfWork UoW
@inject NavigationManager Nav

@rendermode InteractiveServer

<PageTitle>@(Id.HasValue ? "Editar" : "Nuevo") Empleado</PageTitle>

<h3 class="mb-4">@(Id.HasValue ? "Editar" : "Crear") Empleado</h3>

<EditForm Model="empleado" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary class="text-danger mb-3" />

    <!-- Nombre y Apellido -->
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <label class="form-label">Nombre <span class="text-danger">*</span></label>
            <InputText @bind-Value="empleado.Nombre" class="form-control" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Apellido <span class="text-danger">*</span></label>
            <InputText @bind-Value="empleado.Apellido" class="form-control" />
        </div>
    </div>

    <!-- Cédula y Email -->
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <label class="form-label">Cédula <span class="text-danger">*</span></label>
            <InputText @bind-Value="empleado.CedulaNum" class="form-control" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Email</label>
            <InputText @bind-Value="empleado.Email" class="form-control" type="email" />
        </div>
    </div>

    <!-- Teléfono y Departamento -->
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <label class="form-label">Teléfono</label>
            <InputText @bind-Value="empleado.Telefono" class="form-control" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Departamento</label>
            <InputSelect @bind-Value="empleado.IdDepartamento" class="form-select">
                <option value="0">-- Seleccionar --</option>
                @foreach (var d in departamentos)
                {
                    <option value="@d.IdDepartamento">@d.NombreDepartamento</option>
                }
            </InputSelect>
        </div>
    </div>

    <!-- Horario -->
    <div class="mb-4">
        <label class="form-label">Horario <span class="text-danger">*</span></label>
        <InputSelect @bind-Value="horarioSeleccionado" class="form-select">
            <option value="0">-- Seleccionar Horario --</option>
            @foreach (var h in horarios)
            {
                <option value="@h.IdHorario">
                    @h.NombreHorario (@h.HoraEntrada:hh\:mm - @h.HoraSalida:hh\:mm)
                </option>
            }
        </InputSelect>
    </div>

    <!-- ROL (NUEVO) -->
    <div class="mb-4">
        <label class="form-label">Rol <span class="text-danger">*</span></label>
        <InputSelect @bind-Value="rolSeleccionado" class="form-select">
            <option value="0">-- Seleccionar Rol --</option>
            @foreach (var r in roles)
            {
                <option value="@r.IdRol">@r.NombreRol</option>
            }
        </InputSelect>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-success">Guardar</button>
        <button type="button" class="btn btn-secondary ms-2" @onclick="Cancelar">Cancelar</button>
    </div>
</EditForm>

@code {
    [Parameter] public int? Id { get; set; }

    private Empleado empleado = new();
    private List<Departamento> departamentos = new();
    private List<Horario> horarios = new();
    private List<Rol> roles = new();                    
    private int horarioSeleccionado = 0;
    private int rolSeleccionado = 0;                    

    protected override async Task OnInitializedAsync()
    {
        departamentos = await DepartamentoService.ObtenerActivosAsync();
        horarios = await HorarioService.ObtenerActivosAsync();
        roles = await RolService.ObtenerActivosAsync();  
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id.HasValue && Id.Value > 0)
        {
            var emp = await EmpleadoService.ObtenerPorId(Id.Value);
            if (emp is not null)
            {
                empleado = emp;

                
                var relHorario = await UoW.EmpleadoHorarios.GetAllAsync();
                var actualHorario = relHorario.FirstOrDefault(eh => eh.IdEmpleado == Id.Value);
                horarioSeleccionado = actualHorario?.IdHorario ?? 0;

                
                var relRol = await UoW.EmpleadoRoles.GetAllAsync();
                var actualRol = relRol.FirstOrDefault(er => er.IdEmpleado == Id.Value);
                rolSeleccionado = actualRol?.IdRol ?? 0;
            }
        }
    }

    private async Task Guardar()
    {
        if (horarioSeleccionado <= 0 || rolSeleccionado <= 0)
        {
            
            return;
        }

        bool exito = Id.HasValue
            ? await EmpleadoService.Actualizar(empleado, horarioSeleccionado, rolSeleccionado)
            : (await EmpleadoService.Agregar(empleado, horarioSeleccionado, rolSeleccionado)).IdEmpleado > 0;

        if (exito)
            Nav.NavigateTo("/empleados/list");
    }

    private void Cancelar() => Nav.NavigateTo("/empleados/list");
}