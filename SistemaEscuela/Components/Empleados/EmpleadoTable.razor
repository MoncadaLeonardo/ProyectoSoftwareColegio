@page "/empleados/list"
@using EL
@using BL
@using DAL
@inject EmpleadoService EmpleadoService
@inject RolService RolService
@inject IUnitOfWork UoW
@inject NavigationManager Nav
@rendermode InteractiveServer
@inject DepartamentoService DepartamentoService
@inject HorarioService HorarioService
@inject RolService RolService


<PageTitle>Lista de Empleados</PageTitle>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Lista de Empleados</h3>

        <!-- BUSCADOR -->
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text">Buscar</span>
                <input type="text" class="form-control" placeholder="Nombre o apellido..."
                       @bind="filtro" @bind:event="oninput" />
                @if (!string.IsNullOrEmpty(filtro))
                {
                    <button class="btn btn-outline-secondary" @onclick="() => filtro = string.Empty">×</button>
                }
            </div>
        </div>
    </div>

    @if (empleadosFiltrados == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (!empleadosFiltrados.Any())
    {
        <div class="alert alert-light text-center border">
            No se encontraron empleados.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped align-middle shadow-sm">
                <thead class="table-primary">
                    <tr>
                        <th>Empleado</th>
                        <th>Cédula</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Departamento</th>
                        <th>Horario</th>
                        <th>Rol</th>          
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var emp in empleadosFiltrados)
                    {
                        var depto = departamentos?.FirstOrDefault(d => d.IdDepartamento == emp.IdDepartamento);
                        var relHorario = relacionesHorario?.FirstOrDefault(r => r.IdEmpleado == emp.IdEmpleado);
                        var horario = relHorario != null
                        ? horarios?.FirstOrDefault(h => h.IdHorario == relHorario.IdHorario)
                        : null;

                        
                        var relRol = relacionesRol?.FirstOrDefault(r => r.IdEmpleado == emp.IdEmpleado);
                        var rol = relRol != null
                        ? roles?.FirstOrDefault(r => r.IdRol == relRol.IdRol)
                        : null;

                        <tr class="@(emp.Activo ? "" : "table-secondary opacity-75")">
                            <td><strong>@emp.Nombre @emp.Apellido</strong></td>
                            <td>@emp.CedulaNum</td>
                            <td>
                                @if (!string.IsNullOrEmpty(emp.Email))
                                {
                                    <a href="mailto:@emp.Email" class="text-decoration-none">@emp.Email</a>
                                }
                                else
                                {

                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>@(string.IsNullOrEmpty(emp.Telefono) ? "—" : emp.Telefono)</td>
                            <td>
                                <span class="badge bg-info text-dark">
                                    @(depto?.NombreDepartamento ?? "Sin asignar")
                                </span>
                            </td>
                            <td>
                                @if (horario != null)
                                {
                                    <div>
                                        <span class="badge bg-success mb-1">@horario.NombreHorario</span>
                                        <br />
                                        <small class="text-muted">@horario.HoraEntrada:hh\:mm - @horario.HoraSalida:hh\:mm</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Sin horario</span>
                                }
                            </td>

                            
                            <td>
                                @if (rol != null)
                                {
                                    <span class="badge bg-primary fs-6">
                                        @rol.NombreRol
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Sin rol</span>
                                }
                            </td>

                            <td>
                                <span class="badge @(emp.Activo ? "bg-success" : "bg-danger")">
                                    @(emp.Activo ? "Activo" : "Inactivo")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-3 text-muted small">
            Mostrando <strong>@empleadosFiltrados.Count</strong> de <strong>@empleados?.Count</strong> empleados
        </div>
    }
</div>

@code {
    private List<Empleado>? empleados;
    private List<Departamento>? departamentos;
    private List<Horario>? horarios;
    private List<Rol>? roles;                    
    private List<EmpleadoHorario>? relacionesHorario;
    private List<EmpleadoRol>? relacionesRol;    

    private string filtro = string.Empty;
    private List<Empleado> empleadosFiltrados => string.IsNullOrWhiteSpace(filtro)
        ? (empleados ?? new())
        : empleados?
            .Where(e => $"{e.Nombre} {e.Apellido}".Contains(filtro, StringComparison.OrdinalIgnoreCase))
            .ToList() ?? new();

    protected override async Task OnInitializedAsync()
    {
        empleados = await EmpleadoService.ObtenerTodos();
        departamentos = await DepartamentoService.ObtenerActivosAsync();
        horarios = await HorarioService.ObtenerActivosAsync();
        roles = await RolService.ObtenerActivosAsync();           
        relacionesHorario = await UoW.EmpleadoHorarios.GetAllAsync();
        relacionesRol = await UoW.EmpleadoRoles.GetAllAsync();     
    }
}

